<!doctype html>
	<head>
		<title>An RSS and Atom Reader, Bookmarklet App</title>
		<style type="text/css">
		html, body{
			font-size: 17px/17px;
		}
		body{
			margin: 0;
			padding: 0;
		}
		h1, h2, h3, h4, h5, h6{
			margin: 0;
			padding: 0;
		}
		#sidebar{
			position: fixed;
			top:0;
			left: 0;
			width: 300px;
			border-right: 1px solid #dbdbdb;
			background: #eee;
		}
		#mainArea{
			margin-left: 300px;
		}
		nav a{
			display: block;
		}
		img{
			width: 100%;
		}
		
		</style>
	</head>
	<body>
		<section id="sidebar">
			<nav id="feeds"></nav>
		</section>
		<section id="mainArea"></section>
	</body>
	<script>
		var Xml = (function(){
			function parseText (sValue) {
			  if (/^\s*$/.test(sValue)) { return null; }
			  if (/^(?:true|false)$/i.test(sValue)) { return sValue.toLowerCase() === "true"; }
			  if (isFinite(sValue)) { return parseFloat(sValue); }
			  if (isFinite(Date.parse(sValue))) { return new Date(sValue); }
			  return sValue;
			}
			function getJXONTree (oXMLParent) {
			  var vResult = /* put here the default value for empty nodes! */ true, nLength = 0, sCollectedTxt = "";
			  if (oXMLParent.hasAttributes()) {
			    vResult = {};
			    for (nLength; nLength < oXMLParent.attributes.length; nLength++) {
			      oAttrib = oXMLParent.attributes.item(nLength);
			      vResult["@" + oAttrib.name.toLowerCase()] = parseText(oAttrib.value.trim());
			    }
			  }
			  if (oXMLParent.hasChildNodes()) {
			    for (var oNode, sProp, vContent, nItem = 0; nItem < oXMLParent.childNodes.length; nItem++) {
			      oNode = oXMLParent.childNodes.item(nItem);
			      if (oNode.nodeType === 4) { sCollectedTxt += oNode.nodeValue; } /* nodeType is "CDATASection" (4) */
			      else if (oNode.nodeType === 3) { sCollectedTxt += oNode.nodeValue.trim(); } /* nodeType is "Text" (3) */
			      else if (oNode.nodeType === 1 && !oNode.prefix) { /* nodeType is "Element" (1) */
			        if (nLength === 0) { vResult = {}; }
			        sProp = oNode.nodeName.toLowerCase();
			        vContent = getJXONTree(oNode);
			        if (vResult.hasOwnProperty(sProp)) {
			          if (vResult[sProp].constructor !== Array) { vResult[sProp] = [vResult[sProp]]; }
			          vResult[sProp].push(vContent);
			        } else { vResult[sProp] = vContent; nLength++; }
			      }
			    }
			  }
			  if (sCollectedTxt) { nLength > 0 ? vResult.keyValue = parseText(sCollectedTxt) : vResult = parseText(sCollectedTxt); }
			  /* if (nLength > 0) { Object.freeze(vResult); } */
			  return vResult;
			}
			return {
				toJson: getJXONTree
			};
		})();
		var Observable = function(){
			var observers = {};
			var self = {
				observe: function(key, observer){
					if(observers[key] === undefined) observers[key] = [];
					observers[key].push(observer);
				}
				, stopObserving: function(observer){
					for(var key in observers){
						var i = 0;
						var ubounds = observers[key].length;				
						for(i; i < ubounds; i++){
							if(observers[key][i] === observer){
								observers[key].splice(i, 1);
								if(observers[key].length === 0) delete observers[key];
								break;
							}
						}
					}
				}
				, changed: function(key, old, v){
					if(observers[key] === undefined) return;
					var i = 0;
					var ubounds = observers[key].length;
					for(i; i<ubounds; i++){
						observers[key][i](key, old, v, this);
					}
				}
				, release: function(){
					var key = null;
					for(key in observers){
						var observer = null;
						while(observer = observers[key].pop()){}			
					}
				}
			};
			return self;
		};
		var List = function(list){
			var innerList = list || [];
			var self = Observable();
			Object.defineProperty(self, 'length', {
				get: function(){ return innerList.length;}
				, enumerable: true
			});
			Object.defineProperty(self, 'all', {
				get: function(){ return innerList;}
				, enumerable: true
			});
			self.push = function(feed){
				innerList.push(feed);
				this.changed('push', null, feed);
			};
			self.find = function(delegate){
				var i = 0;
				var ubounds = innerList.length;
				for(i; i < ubounds; i++){
					if(delegate(i, innerList[i])) return innerList[i];
				}
				return null;
			};
			self.remove = function(delegate){
				var i = 0;
				var ubounds = innerList.length;
				var deleted = [];
				for(i; i < ubounds; i++){
					if(delegate(innerList[i])){
						deleted = innerList.splice(i, 1);
						this.changed('remove', deleted[0], i);
						break;
					}
				}
				return deleted[0];
			};
			return self;
		};
		var View = function(container, controller){
			var self = {
				container: container
				, controller: controller
				, views: []
				, release: function release(){
					if(!this.container.parentNode) return;
					this.container.parentNode.removeChild(this.container);
					this.controller.release();
					var view = null;
					while(view = this.views.pop()) view.release();
				}
			};
			self.controller.setView(self);
			return self;
		};
		var Controller = function Controller(delegate, model){
			var self = {
				model: model
				, delegate: delegate
				, release: function release(){}
				, view: null
			};
			self.setView = function(v){
				this.view = v;
				if(this.didSetView) this.didSetView();
			};
			self.release = function(){
				if(model.release) model.release();
			}
			return self;
		};
		var Feed = function(obj){
			var self = Observable();
			function getLink(obj){
				return {
					href: obj.channel ? obj.channel.link : obj.link['@href']
				};
			}
			function getEntries(obj){
				var entries = [];
				if(obj.channel){
					obj.channel.item.forEach(function(item){
						entries.push({author: {name: null}, content: {type: 'html', keyValue: item.description, id: item.link, title: item.title, published: item.pubdate, hero: item.enclosure ? item.enclosure['@url'] : null}});
					});
				}else{
					obj.entry.forEach(function(item){
						var div = document.createElement('div');
						div.innerHTML = item.content.keyValue;
						var hero = div.querySelector('img');
						entries.push({author: {name: item.author.name}, content: {type: item.content['@type'], keyValue: item.content.keyValue, id: item.id, title: item.title, published: item.published}, hero: hero ? hero.src : null});
					});
				}
				return entries;
			}
			function getIcon(obj){
				return obj.icon || null;
			}
			function getTitle(obj){
				return obj.title || obj.channel.title;
			}
			self.link = getLink(obj);
			self.entries = getEntries(obj);
			self.icon = getIcon(obj);
			self.title = getTitle(obj);
			return self;
		};
		var FeedList = function(){
			var self = List();
			var active = null;
			Object.defineProperty(self, 'active', {
				get: function(){return active;}
				, set: function(v){
					var old = active;
					active = v;
					this.changed('active', old, v, this);
				}
			})
			return self;
		};
		var FeedsView = function(container, controller){
			var self = View(container, controller);
			function addLink(feed){
				var a = document.createElement('a');				
				a.setAttribute('href', feed.link.href);
				a.innerHTML = feed.title;
				self.container.appendChild(a);
			}
			self.added = function(key, old, v, m){				
				addLink(v);
			};
			self.removed = function(key, old, v, m){
				var elem = this.container.querySelector('[href="' + v.url + '"]');
				this.container.parentNode.removeChild(elem);
			};
			controller.model.observe('push', self.added);
			controller.model.observe('remove', self.removed);
			self.views.push(ColumnView(self.container, ColumnController(self.controller, self.controller.model)));
			return self;
		};
		var ColumnView = function(container, controller){
			var self = View(container, controller);
			return self;
		};
		var ColumnController = function(delegate, model){
			var self = Controller(delegate, model);
			function resize(height){
				self.view.container.style['height'] = height + 'px';
			}
			function getViewportHeight(){
				return Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
			}
			function getViewportWidth(){
				return Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
			}
			self.handleEvent = function(e){
				if(getViewportWidth() <= 400) return;
				resize(getViewportHeight());
			};
			self.didSetView = function(v){
				window.addEventListener('resize', self, true);
				resize(getViewportHeight());
			};
			return self;
		};
		var FeedController = function(delegate, model){
			var self = Controller(delegate, model);
			self.handleEvent = function(e){
				e.preventDefault();
				if(e.target.nodeName !== 'A') return;
				delegate.feedLinkWasClicked(e.target);
			};
			self.didSetView = function(v){
				this.view.container.addEventListener('click', this, true);
			};
			return self;
		};
		
		var ActiveFeedView = function(container, controller){
			var self = View(container, controller);
			self.activeWasUpdated = function(key, old, v, m){
				self.container.innerHTML = '';
				v.entries.forEach(function(entry){
					var div = document.createElement('div');
					var header = document.createElement('h1');
					var article = document.createElement('article');
					header.innerHTML = '<a href="{href}">{title}</a>'.replace(/\{href\}/, entry.content.id).replace(/\{title\}/, entry.content.title);
					article.innerHTML = entry.content.keyValue;
					div.appendChild(header);
					div.appendChild(article);
					self.container.appendChild(div);
				});
			};
			controller.model.observe('active', self.activeWasUpdated);
		};
		var ActiveFeedController = function(delegate, model){
			var self = Controller(delegate, model);
			return self;
		};
		var model = FeedList();
		model.active = null;
		var favoriteFeeds = function(){
			return model;
		};
		var app = {
			requestDidLoad: function(e){
				console.log('loaded', e);
			}
			, handleEvent: function(e){
				if(e.target.readyState !== 4) return;
				if(e.target.status === 200){
					var i = 0;
					var root = e.target.responseXML.childNodes[i];
					while(!root.hasAttributes && i < 10) root = e.target.responseXML.childNodes[i++];
					var feed = Xml.toJson(root);
					model.push(Feed(feed));
				}
			}
			, errorDidHappen: function(e){
				console.log('error', e);
			}
			, feedLinkWasClicked: function(link){
				model.active = model.find(function(i, feed){
					return feed.link.href === link.href;
				});
			}
			, views: []
		};
		var addFeed = function(url, handler){
			var xhr = new XMLHttpRequest();
			xhr.addEventListener('readystatechange', handler);
			xhr.open('get', url, true);
			xhr.send();
		};
		var deleteFeed = function(url){
			return model.remove(function(feed){
				return feed.url === url;
			});
		};
		
		app.views.push(FeedsView(document.getElementById('feeds'), FeedController(app, model)));
		app.views.push(ActiveFeedView(document.getElementById('mainArea'), ActiveFeedController(app, model)));
		addFeed('http://backend.deviantart.com/rss.xml?type=deviation&q=boost%3Apopular+in%3Adigitalart%2Fdrawings+frogs', app);
		addFeed('http://digg.com/rss/top.rss', app);
		addFeed('http://www.reddit.com/.rss', app);
		addFeed('https://news.ycombinator.com/rss', app);
		addFeed('http://readwrite.com/rss.xml', app);
		addFeed('http://www.theverge.com/rss/frontpage', app);
	</script>
</html>